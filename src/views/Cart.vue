<template>
  <ion-page>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-buttons slot="start">
          <ion-button slot="start" routerLink="/home/vente">
            <ion-icon :src="getIcon('arrowBack')"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>UMUHORA</ion-title>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <CartItem v-for="item in cart.content" :item="item"/>
      <div class="total">
        <div>Total:</div>
        <b>{{ money(cart.getTotal()) }} </b>
        <div> BIF</div>
      </div>
      <ion-col class="create">
        <ion-item class="ion-no-padding">
          <ion-label position="floating">Nom du client</ion-label>
          <ion-input type=text placeholder="Nom du client"
            :value="nom" @IonChange="setNom($event.target.value)" clearInput/>
        </ion-item>
        <ion-item class="ion-no-padding">
          <ion-label position="floating">Télephone du client</ion-label>
          <ion-input type="number" placeholder="Télephone du client"
            :value="tel" @IonChange="setTel($event.target.value)" clearInput/>
        </ion-item>
      </ion-col>
      <div class="clients" v-if="nom.length>0 || tel.length>0">
        <h4 v-if="found_clients">Les clients trouvés</h4>
        <div class="client" v-for="client in found_clients">
          <input type="radio" :value="client" :id="client.tel" v-model="active_client">
          <label :for="client.tel">{{client.nom}} {{client.tel}}</label>
        </div>
      </div>
    </ion-content>
    <ion-footer>
      <div class="payment">
        <ion-label>le montant payé:</ion-label>
        <input type="number" v-model="paid">
        <ion-label>BIF</ion-label>
      </div>
      <div class="payment">
        <ion-label>{{ ingaru<0?"ayo kugarura":"ideni rya" }}:</ion-label>
        <b>{{ money(Math.abs(ingaru)) }}</b>
        <ion-label>BIF</ion-label>
      </div>
      <div class="two-cols">
        <ion-button size="6" @click="clearCart">RESET</ion-button>
        <ion-button size="6" @click="submitVente">SUBMIT</ion-button>
      </div>
    </ion-footer>
  </ion-page>
</template>
<script>
import CartItem from "../components/cart_item"
export default {
  components:{ CartItem },
  data(){
    return {
      nom:"", tel:"", paid:this.$store.state.cart.getTotal(),
      active_client:null, found_clients:[]
    }
  },
  computed:{
    ingaru(){
      return this.$store.state.cart.getTotal() - this.paid
    },
    cart(){
      return this.$store.state.cart
    }
  },
  watch:{
    "$store.state.cart.content":{
      deep:true,
      handler(new_val){
        this.paid = this.cart.getTotal()
      }
    },
    active_client(new_val){
      if(new_val){
        this.nom = new_val.nom
        this.tel = new_val.tel
      }
    }
  },
  methods:{
    clearCart(){
      this.cart.content = []
    },
    setTel(value){
      this.tel = value
      this.searchFor(value)
    },
    setNom(value){
      this.nom = value
      this.searchFor(value)
    },
    searchFor(keyword){
      if(nom.length == 0 && tel.length == 0){
        this.found_clients = []
      }
      this.found_clients = this.$store.state.clients.filter(x => {
        x.nom.includes(keyword) || x.tel.includes(keyword)
      })
    },
    submitVente(){
      let client_infos_are_correct = (this.tel.length>=7)&&(this.nom.length>=3)
      if(this.ingaru > 0){
        if(!client_infos_are_correct){
          console.error("pour les dettes le client est obligatiore")
          return;
        }
      }
      let data = {};
      let items = [];
      let client;
      if(client_infos_are_correct){
        client = {
          "nom":this.nom,
          "tel":this.tel
        }
        this.$store.state.clients.push(client)
      }
      for(let item of this.cart.content){
        items.unshift({"produit":item.product.id, "quantite":item.quantite})
      }
      if(items.length==0){
        console.error("les ventes nulles ne sont pas plausible")
        return;
      }
      let payee = this.paid<=this.cart.getTotal()?this.paid:this.cart.getTotal()
      data = {
        "payee":payee,
        "client": client,
        "ventes":items,
        "user":this.active_user.id,
        "date":new Date(),
        "kiosk":this.getActiveKiosk().id
      };
      for(let item of this.cart.content){
        item.product.quantite -= item.quantite
      }
      this.cart.content = []
      this.$store.state.created_commandes.push(data)
      this.$router.push("/")
    }
  },
  mounted(){
    // if(this.$store.state.clients.length<1){
    //   this.fetchData()
    // }
  }
}
</script>
<style scoped>
.payment{
  display: flex;
  justify-content: center;
  align-items: center;
}
.payment input{
  width: 80px;
  padding: 5px;
  margin: 5px;
  text-align: right;
}
.total{
  display: flex;
  justify-content: right;
}
.two-cols{
  display: flex;
}
.two-cols>*{
  flex-grow: 1;
}
.item-native{
  padding-left: 0!important;
}
.client{
  display: flex;
  align-items: center; 
  margin-bottom: 5px; 
}
.client>*{
  margin-right: 5px;
}
</style>